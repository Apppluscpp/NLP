from flask import Blueprint, render_template, request, redirect, url_for
import fitz
from pdfminer.high_level import extract_text
import os
from io import BytesIO

views = Blueprint("views", __name__)

@views.route("/upload_and_process", methods=["POST"])
def upload_and_process():
    if "pdf_file" not in request.files:
        return "No file part"

    pdf_file = request.files["pdf_file"]

    if pdf_file.filename == "":
        return "No selected file"

    # Check if the file is a PDF
    if pdf_file.filename.endswith(".pdf"):
        text_content = extract_text_from_pdf(pdf_file)

        # Save the text content to a text file
        save_to_text_file(text_content)

        # Redirect to a new route to display the result without showing the text
        return redirect(url_for("views.display_result"))

    return "Unsupported file format. Please upload a PDF file."

@views.route("/display_result")
def display_result():
    return render_template("result.html")

def extract_text_from_file_storage(file_storage):
    content_bytes = file_storage.read()
    content_stream = BytesIO(content_bytes)
    return extract_text(content_stream)

def extract_text_from_pdf(pdf_file):
    text_content = ""

    # Extract the filename without the extension
    filename_without_extension = os.path.splitext(pdf_file.filename)[0]

    # Extract text using PyMuPDF
    doc = fitz.open(stream=pdf_file.read(), filetype="pdf")
    for page_number in range(doc.page_count):
        page = doc[page_number]
        text_content += page.get_text()
    doc.close()

    # Extract text using pdfminer
    pdf_file.seek(0)  # Reset file pointer
    text_content += extract_text_from_file_storage(pdf_file)

    return text_content

def save_to_text_file(text_content):
    with open("converted_text.txt", "w", encoding="utf-8") as text_file:
        text_file.write(text_content)
